# Dumi 工作流程详细图解

## 1️⃣ Demo 自动生成流程

```
┌─────────────────────────────────────────────────────────────────┐
│                     Markdown 文件                                │
│  src/Button/index.md                                            │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ # Button                                                 │  │
│  │                                                          │  │
│  │ ## 基础用法                                              │  │
│  │                                                          │  │
│  │ ```jsx                                                   │  │
│  │ import Button from './index.tsx';                        │  │
│  │ export default () => <Button>Click me</Button>           │  │
│  │ ```                                                      │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────┬──────────────────────────────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │   Remark 解析 Markdown         │
        │   生成 MDAST (AST)             │
        └────────────────┬───────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │   遍历 AST 节点                 │
        │   找到 code 块 (language=jsx)  │
        └────────────────┬───────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │   提取代码内容                  │
        │   生成唯一 ID                   │
        │   button-demo-0                │
        └────────────────┬───────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │   创建虚拟模块                  │
        │   .dumi/tmp/~demos/            │
        │   button-demo-0/index.tsx      │
        └────────────────┬───────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │   注册到路由系统                │
        │   /~demos/button-demo-0        │
        └────────────────┬───────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │   webpack 编译虚拟模块          │
        │   生成可执行的 JS 代码          │
        └────────────────┬───────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │   浏览器加载并执行              │
        │   渲染 React 组件               │
        └────────────────────────────────┘
```

---

## 2️⃣ 热更新 (HMR) 完整流程

```
┌──────────────────────────────────────────────────────────────────┐
│                        开发环境                                   │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │  编辑器修改文件                                         │   │
│  │  src/Button/index.tsx                                   │   │
│  │  ┌───────────────────────────────────────────────────┐ │   │
│  │  │ const Button: FC<ButtonProps> = ({              │ │   │
│  │  │   backgroundColor = '#1890ff',  ← 修改颜色      │ │   │
│  │  │ }) => { ... }                                   │ │   │
│  │  └───────────────────────────────────────────────────┘ │   │
│  └────────────────────┬──────────────────────────────────┘   │
│                       │                                       │
│                       ▼                                       │
│  ┌────────────────────────────────────────────────────────┐  │
│  │  Chokidar 文件监听                                     │  │
│  │  检测到 index.tsx 变更                                 │  │
│  └────────────────────┬─────────────────────────────────┘  │
│                       │                                      │
│                       ▼                                      │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  webpack 增量编译                                      │ │
│  │  ├─ 读取缓存                                           │ │
│  │  ├─ 只重新编译变更模块                                 │ │
│  │  └─ 生成新的模块代码                                   │ │
│  └────────────────────┬─────────────────────────────────┘ │
│                       │                                     │
│                       ▼                                     │
│  ┌────────────────────────────────────────────────────────┐│
│  │  webpack-dev-server 生成更新清单                       ││
│  │  {                                                     ││
│  │    "h": "abc123...",                                   ││
│  │    "c": ["./src/Button/index.tsx"],                    ││
│  │    "r": [],                                            ││
│  │    "m": []                                             ││
│  │  }                                                     ││
│  └────────────────────┬──────────────────────────────────┘│
│                       │                                    │
└───────────────────────┼────────────────────────────────────┘
                        │
                        │ WebSocket
                        │
┌───────────────────────▼────────────────────────────────────┐
│                    浏览器端                                 │
│                                                            │
│  ┌──────────────────────────────────────────────────────┐ │
│  │  webpack-dev-server 客户端                           │ │
│  │  接收 HMR 更新消息                                   │ │
│  └──────────────────┬─────────────────────────────────┘ │
│                     │                                    │
│                     ▼                                    │
│  ┌──────────────────────────────────────────────────────┐ │
│  │  请求新的模块代码                                    │ │
│  │  GET /src/Button/index.tsx?hash=abc123              │ │
│  └──────────────────┬─────────────────────────────────┘ │
│                     │                                    │
│                     ▼                                    │
│  ┌──────────────────────────────────────────────────────┐ │
│  │  React Fast Refresh 拦截更新                        │ │
│  │  ├─ 保留组件状态                                     │ │
│  │  ├─ 保留 Hook 状态                                   │ │
│  │  └─ 更新组件代码                                     │ │
│  └──────────────────┬─────────────────────────────────┘ │
│                     │                                    │
│                     ▼                                    │
│  ┌──────────────────────────────────────────────────────┐ │
│  │  执行 module.hot.accept() 回调                       │ │
│  │  重新渲染组件                                        │ │
│  └──────────────────┬─────────────────────────────────┘ │
│                     │                                    │
│                     ▼                                    │
│  ┌──────────────────────────────────────────────────────┐ │
│  │  浏览器 UI 实时更新                                  │ │
│  │  按钮颜色从 #1890ff 变为新颜色                       │ │
│  │  (< 100ms)                                           │ │
│  └──────────────────────────────────────────────────────┘ │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

---

## 3️⃣ 文档构建 (dumi build) 流程

```
┌──────────────────────────────────────────────────────────────┐
│                   dumi build 命令                            │
└────────────────────┬─────────────────────────────────────────┘
                     │
                     ▼
        ┌────────────────────────────────┐
        │   1. 加载配置文件              │
        │   .dumirc.ts                   │
        │   ├─ outputPath                │
        │   ├─ resolve.entryFile         │
        │   └─ themeConfig               │
        └────────────────┬───────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │   2. 初始化 Umi 框架           │
        │   ├─ 加载插件                  │
        │   ├─ 注册生命周期              │
        │   └─ 生成临时文件              │
        └────────────────┬───────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │   3. 扫描源文件                │
        │   ├─ src/**/*.md               │
        │   ├─ src/**/*.tsx              │
        │   └─ docs/**/*.md              │
        └────────────────┬───────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │   4. 解析 Markdown             │
        │   ├─ remark 解析               │
        │   ├─ 提取代码块                │
        │   └─ 生成虚拟模块              │
        └────────────────┬───────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │   5. 提取 API 文档             │
        │   ├─ react-docgen 解析 Props   │
        │   ├─ TypeScript 类型提取       │
        │   └─ JSDoc 注释解析            │
        └────────────────┬───────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │   6. 生成路由配置              │
        │   ├─ /components/button        │
        │   ├─ /components/foo           │
        │   └─ /guide                    │
        └────────────────┬───────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │   7. webpack 生产构建          │
        │   ├─ 入口: .dumi/tmp/umi.ts    │
        │   ├─ 输出: docs-dist/          │
        │   └─ 优化: 代码分割、压缩      │
        └────────────────┬───────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │   8. 代码优化                  │
        │   ├─ Terser 压缩 JS            │
        │   ├─ cssnano 压缩 CSS          │
        │   └─ 图片优化                  │
        └────────────────┬───────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │   9. 生成 HTML 文件            │
        │   ├─ index.html                │
        │   ├─ components/button/        │
        │   ├─ components/foo/           │
        │   └─ guide/                    │
        └────────────────┬───────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │   10. 生成元数据               │
        │   ├─ sitemap.xml               │
        │   ├─ manifest.json             │
        │   └─ 搜索索引                  │
        └────────────────┬───────────────┘
                         │
                         ▼
        ┌────────────────────────────────┐
        │   完成！                       │
        │   docs-dist/ 已生成            │
        └────────────────────────────────┘
```

---

## 4️⃣ Markdown 代码块处理详解

```
原始 Markdown
┌──────────────────────────────────────────┐
│ ## 基础用法                              │
│                                          │
│ ```jsx                                   │
│ import Button from './index.tsx';        │
│ export default () => <Button>Click</Button>
│ ```                                      │
└──────────────────┬───────────────────────┘
                   │
                   ▼
        ┌──────────────────────────┐
        │  Remark 解析             │
        │  生成 MDAST              │
        │  {                       │
        │    type: 'code',         │
        │    lang: 'jsx',          │
        │    value: '...',         │
        │    meta: null            │
        │  }                       │
        └──────────────┬───────────┘
                       │
                       ▼
        ┌──────────────────────────┐
        │  Dumi 插件处理           │
        │  ├─ 生成 ID              │
        │  ├─ 提取标题             │
        │  └─ 创建虚拟模块         │
        └──────────────┬───────────┘
                       │
                       ▼
        ┌──────────────────────────┐
        │  虚拟模块                │
        │  .dumi/tmp/~demos/       │
        │  button-demo-0/          │
        │  index.tsx               │
        │  ┌────────────────────┐  │
        │  │import Button from  │  │
        │  │'../../src/Button'; │  │
        │  │export default ()=> │  │
        │  │<Button>Click</...> │  │
        │  └────────────────────┘  │
        └──────────────┬───────────┘
                       │
                       ▼
        ┌──────────────────────────┐
        │  Webpack 编译            │
        │  ├─ TypeScript 转译      │
        │  ├─ Babel 处理 JSX       │
        │  └─ 生成 JS 代码         │
        └──────────────┬───────────┘
                       │
                       ▼
        ┌──────────────────────────┐
        │  浏览器执行              │
        │  ├─ 加载模块             │
        │  ├─ 渲染组件             │
        │  └─ 显示 Demo            │
        └──────────────────────────┘
```

---

## 5️⃣ 文件变更检测与编译流程

```
┌─────────────────────────────────────────────────────────┐
│                  文件系统                               │
│                                                         │
│  src/Button/index.tsx  ◄─── 用户编辑                   │
│  src/Button/index.md   ◄─── 用户编辑                   │
│  src/Button/index.css  ◄─── 用户编辑                   │
└────────────────────┬──────────────────────────────────┘
                     │
                     ▼
        ┌────────────────────────────┐
        │  Chokidar 监听             │
        │  (文件监听库)              │
        │  ├─ 监听 src/ 目录         │
        │  ├─ 监听 docs/ 目录        │
        │  └─ 忽略 node_modules      │
        └────────────────┬───────────┘
                         │
                         ▼
        ┌────────────────────────────┐
        │  事件触发                  │
        │  ├─ add (新文件)           │
        │  ├─ change (修改)          │
        │  └─ unlink (删除)          │
        └────────────────┬───────────┘
                         │
                         ▼
        ┌────────────────────────────┐
        │  Webpack 编译器            │
        │  ├─ 读取缓存               │
        │  ├─ 增量编译               │
        │  └─ 生成更新清单           │
        └────────────────┬───────────┘
                         │
                         ▼
        ┌────────────────────────────┐
        │  webpack-dev-server        │
        │  ├─ 生成 HMR 消息          │
        │  ├─ 通过 WebSocket 发送    │
        │  └─ 推送到浏览器           │
        └────────────────┬───────────┘
                         │
                         ▼
        ┌────────────────────────────┐
        │  浏览器接收更新            │
        │  ├─ 请求新模块代码         │
        │  ├─ React Fast Refresh     │
        │  └─ 更新 DOM               │
        └────────────────────────────┘
```

---

## 6️⃣ 虚拟模块系统

```
Dumi 虚拟模块结构
┌─────────────────────────────────────────────────────┐
│  .dumi/tmp/                                         │
│  ├── core/                                          │
│  │   ├── config.ts          (Dumi 配置)            │
│  │   └── routes.ts          (路由配置)             │
│  ├── dumi/                                          │
│  │   ├── theme/             (主题文件)             │
│  │   ├── layouts/           (布局组件)             │
│  │   └── slots/             (插槽组件)             │
│  ├── ~demos/                (Demo 虚拟模块)        │
│  │   ├── button-demo-0/                            │
│  │   │   └── index.tsx      (虚拟 demo 文件)      │
│  │   ├── button-demo-1/                            │
│  │   │   └── index.tsx                             │
│  │   └── foo-demo-0/                               │
│  │       └── index.tsx                             │
│  ├── ~pages/                (页面虚拟模块)        │
│  │   ├── Button__index.md.tsx                      │
│  │   ├── Foo__index.md.tsx                         │
│  │   └── docs__guide.md.tsx                        │
│  └── umi.ts                 (Umi 入口文件)        │
└─────────────────────────────────────────────────────┘

虚拟模块导入示例
┌─────────────────────────────────────────────────────┐
│  import Demo from '~demos/button-demo-0';           │
│  // 实际加载: .dumi/tmp/~demos/button-demo-0/...   │
│                                                     │
│  import Page from '~pages/Button__index.md';        │
│  // 实际加载: .dumi/tmp/~pages/Button__index.md... │
└─────────────────────────────────────────────────────┘
```

---

## 7️⃣ 完整的请求响应流程

```
用户在浏览器中访问 http://localhost:8000/components/button
│
├─ 1. 请求 HTML
│  └─► webpack-dev-server 返回 index.html
│
├─ 2. 加载 JavaScript
│  └─► 加载 umi.js (主应用代码)
│
├─ 3. 初始化 Umi 应用
│  ├─ 加载路由配置
│  ├─ 匹配 /components/button 路由
│  └─ 动态导入对应页面组件
│
├─ 4. 加载页面组件
│  └─► 加载 ~pages/Button__index.md.tsx
│
├─ 5. 渲染页面
│  ├─ 解析 Markdown 内容
│  ├─ 渲染文本和标题
│  └─ 加载 Demo 组件
│
├─ 6. 加载 Demo 组件
│  ├─ 加载 ~demos/button-demo-0
│  ├─ 加载 ~demos/button-demo-1
│  └─ 加载 ~demos/button-demo-2
│
├─ 7. 建立 WebSocket 连接
│  └─► webpack-dev-server 建立 HMR 连接
│
└─ 8. 页面完全加载
   └─► 用户可以看到完整的文档页面
```

---

## 📊 性能优化策略

```
Dumi 的性能优化
├─ 代码分割
│  ├─ 路由级别分割
│  ├─ Demo 独立加载
│  └─ 第三方库分离
│
├─ 缓存策略
│  ├─ webpack 持久化缓存
│  ├─ 浏览器缓存
│  └─ CDN 缓存
│
├─ 编译优化
│  ├─ 增量编译
│  ├─ 并行编译
│  └─ 缓存复用
│
└─ 运行时优化
   ├─ 懒加载
   ├─ 预加载
   └─ 虚拟滚动
